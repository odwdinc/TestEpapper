<!DOCTYPE html>
<html>

<head>


<script
  src="https://code.jquery.com/jquery-3.4.1.slim.js"
  integrity="sha256-BTlTdQO9/fascB1drekrDVkaKd9PkwBymMlHOiG+qLI="
  crossorigin="anonymous"></script>

<script language="JavaScript" type="text/javascript">

var ElementList ={}

function myFunction() {
  	console.log('Requesting Bluetooth Device...');
	navigator.bluetooth.requestDevice({
  		filters: [{
    		services: ['19b10000-e8f2-537e-4f6c-d104768a1214']
  		}]
	})
	.then(device => {
    	console.log('Connecting to GATT Server...');
    	return device.gatt.connect();
	})
	.then(server => {
		console.log('Getting Service...');
		return server.getPrimaryService('19b10000-e8f2-537e-4f6c-d104768a1214');
	})
	.then(service => {
		console.log('Getting Characteristics...');
		// Get all characteristics.
		return service.getCharacteristics();
	})
	.then(characteristics => {
		characteristics.forEach(function(characteristic) {
			console.log('> Characteristic: ');
		  	console.log(characteristic.uuid);
		  	document.querySelector('#Button_'+characteristic.uuid).disabled = !characteristic.properties.write;
    		ElementList[characteristic.uuid] = characteristic;
    		characteristic.readValue()
    		.then(value => {
    			let curentVal = value.getUint8(0);
    			switch(characteristic.uuid){
    				case '19b10001-e8f2-537e-4f6c-d104768a1214':
    					console.log('On/Off: '+curentVal);
    					if(curentVal){
    						document.querySelector('#Button_'+characteristic.uuid).text('Turn Off');
    					}else{
    						document.querySelector('#Button_'+characteristic.uuid).text('Turn On');
    					}

    					break;
    				case '19b10003-e8f2-537e-4f6c-d104768a1214':
    					console.log('Rainbow On/Off: '+curentVal);
    					if(curentVal){
    						document.querySelector('#Button_'+characteristic.uuid).text('Turn Rainbow Off');
    					}else{
    						document.querySelector('#Button_'+characteristic.uuid).text('Turn Rainbow On');
    					}
    					break;
    				case '19b10002-e8f2-537e-4f6c-d104768a1214':
    					console.log('Brightness: '+curentVal);
    					document.querySelector('#Brightness').prop('value', curentVal);
    					break;
    				case '19b10004-e8f2-537e-4f6c-d104768a1214':
    					let Red = value.getUint8(0);
    					let Green = value.getUint8(1);
    					let Blue = value.getUint8(2);
    					console.log('Color: '+Red+','+Green+','+Blue);
    					//document.querySelector('#Color').value = value;
    					break
    			}		
    		})
    		.catch(error => {
				document.querySelector('#Button_'+characteristic.uuid).disabled = true;
				console.log('Characteristic Argh! ' + error);
			});
		});
	})
	.catch(error => {
		console.log('Argh! ' + error);
	});
}
</script>
</head>
<body>

<h1>The BLE Event</h1>


<button onclick="myFunction()">Connect to Lights</button>

<p id="demo"></p>
</br>
<button id="Button_19b10001-e8f2-537e-4f6c-d104768a1214" disabled>On/Off</button>
</br>
<button id="Button_19b10002-e8f2-537e-4f6c-d104768a1214" disabled>Brightness</button>
<input id="Brightness" type="number" name="Brightness" min="1" max="31">
</br>
<button id="Button_19b10003-e8f2-537e-4f6c-d104768a1214" disabled>Rainbow On/Off</button>
</br>
<button id="Button_19b10004-e8f2-537e-4f6c-d104768a1214" disabled>Set Color</button>
<input id="Color" type="color" name="favcolor" value="#ff0000">
</br>
</body>
</html>
